{% extends 'base.html' %}

{% block title %}{{ exercise.name }} - {{ session.routine.name }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Exercise Header -->
    <div class="workout-header">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold">{{ exercise.name }}</h1>
                <p class="text-lg opacity-90">{{ session.routine.name }} - {{ session.started_at|date:"M d, Y" }}</p>
            </div>
            <div class="text-right">
                <div class="text-sm opacity-75">Set</div>
                <div class="text-xl">{{ next_set_number }} of {{ routine_exercise.sets_count }}</div>
            </div>
        </div>
    </div>
    
    <!-- Exercise Info -->
    <div class="card mb-6">
        <div class="card-header">Exercise Information</div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold mb-2">Description</h3>
                    <p class="text-muted mb-4">{{ exercise.description }}</p>
                    
                    <h3 class="font-semibold mb-2">Instructions</h3>
                    <p class="text-sm">{{ exercise.instructions }}</p>
                </div>
                
                <div>
                    <!-- Muscle Groups -->
                    <h3 class="font-semibold mb-2">Muscle Groups</h3>
                    <div class="mb-4">
                        {% for muscle_group in exercise.muscle_groups.all %}
                            <span class="muscle-group-tag">{{ muscle_group.name }}</span>
                        {% endfor %}
                    </div>
                    
                    <!-- Equipment -->
                    {% if exercise.equipment_needed %}
                        <h3 class="font-semibold mb-2">Equipment Needed</h3>
                        <p class="text-sm mb-4">{{ exercise.equipment_needed }}</p>
                    {% endif %}
                    
                    <!-- Exercise Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">{{ routine_exercise.sets_count }}</div>
                            <div class="stat-label">Total Sets</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">{{ routine_exercise.rest_time_seconds }}s</div>
                            <div class="stat-label">Rest Time</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Completed Sets -->
    {% if completed_sets %}
        <div class="card mb-6">
            <div class="card-header">Completed Sets</div>
            <div class="card-body">
                <div class="grid grid-cols-1 gap-3">
                    {% for set in completed_sets %}
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-200">
                            <div>
                                <span class="font-semibold">Set {{ set.set_number }}</span>
                                <span class="text-muted ml-2">{{ set.completed_at|date:"g:i A" }}</span>
                            </div>
                            <div class="text-right">
                                <div class="font-bold">{{ set.weight }}kg √ó {{ set.reps }} reps</div>
                                <div class="text-sm text-muted">Volume: {{ set.volume }}kg</div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
    
    <!-- Current Set Input -->
    <div class="card mb-6" id="current-set-card">
        {% if sets_remaining > 0 %}
            <div class="card-header">Set {{ next_set_number }}</div>
            <div class="card-body">
                <div class="set-input-group">
                    <div class="form-group">
                        <label for="weight_{{ next_set_number }}" class="form-label">Weight (kg)</label>
                        <input type="number" 
                               id="weight_{{ next_set_number }}" 
                               name="weight_{{ next_set_number }}" 
                               class="form-control" 
                               step="0.5" 
                               min="0" 
                               placeholder="0.0"
                               {% if routine_exercise.target_weight %}value="{{ routine_exercise.target_weight }}"{% endif %}>
                    </div>
                    
                    <div class="form-group">
                        <label for="reps_{{ next_set_number }}" class="form-label">Reps</label>
                        <input type="number" 
                               id="reps_{{ next_set_number }}" 
                               name="reps_{{ next_set_number }}" 
                               class="form-control" 
                               min="1" 
                               placeholder="0"
                               {% if routine_exercise.target_reps %}value="{{ routine_exercise.target_reps }}"{% endif %}>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Volume</label>
                        <div id="volume_{{ next_set_number }}" class="form-control bg-gray-100 text-center font-bold">
                            0kg
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" 
                                id="save-btn-{{ next_set_number }}" 
                                class="btn btn-success btn-lg"
                                onclick="saveWorkoutSetAndContinue({{ session.id }}, {{ exercise.id }}, {{ next_set_number }}, {{ routine_exercise.sets_count }})">
                            Complete Set
                        </button>
                    </div>
                </div>
                
                {% if routine_exercise.target_reps or routine_exercise.target_weight %}
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-2">Target</h4>
                        <div class="text-blue-700">
                            {% if routine_exercise.target_weight %}
                                Weight: {{ routine_exercise.target_weight }}kg
                            {% endif %}
                            {% if routine_exercise.target_reps %}
                                {% if routine_exercise.target_weight %} | {% endif %}
                                Reps: {{ routine_exercise.target_reps }}
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        {% else %}
            <div class="card-header">Exercise Complete! üéâ</div>
            <div class="card-body text-center">
                <h3 class="text-2xl font-bold text-green-600 mb-4">All sets completed!</h3>
                <p class="text-muted mb-4">Great work! Ready to move on to the next exercise.</p>
                <a href="{% url 'workouts:workout_session' session.id %}" 
                   class="btn btn-success btn-lg">
                    Continue Workout
                </a>
            </div>
        {% endif %}
    </div>
    
    <!-- Navigation -->
    <div class="flex gap-4 mb-6">
        <a href="{% url 'workouts:workout_session' session.id %}" 
           class="btn btn-secondary">
            ‚Üê Back to Workout
        </a>
    </div>
</div>

<!-- Rest Timer (Hidden by default) -->
<div id="rest-timer" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
        <div class="timer-display" id="timer-display">2:00</div>
        <div class="timer-controls">
            <button class="btn btn-secondary" onclick="skipRestAndContinue()">Skip Rest</button>
            <button class="btn btn-primary" onclick="hideTimer()">OK</button>
        </div>
    </div>
</div>

<style>
.bg-green-50 {
    background-color: #f0fdf4;
}

.border-green-200 {
    border-color: #bbf7d0;
}

.bg-blue-50 {
    background-color: #eff6ff;
}

.text-blue-800 {
    color: #1e40af;
}

.text-blue-700 {
    color: #1d4ed8;
}

.bg-gray-100 {
    background-color: #f3f4f6;
}
</style>

<script>
// Global variables for tracking current set
let currentSetNumber = {{ next_set_number }};
let totalSets = {{ routine_exercise.sets_count }};
let sessionId = {{ session.id }};
let exerciseId = {{ exercise.id }};

// Calculate volume in real-time
function updateVolume() {
    const weightInput = document.querySelector('input[name^="weight_"]');
    const repsInput = document.querySelector('input[name^="reps_"]');
    const volumeDisplay = document.querySelector('[id^="volume_"]');
    
    if (weightInput && repsInput && volumeDisplay) {
        const weight = parseFloat(weightInput.value) || 0;
        const reps = parseInt(repsInput.value) || 0;
        const volume = weight * reps;
        volumeDisplay.textContent = volume.toFixed(1) + 'kg';
    }
}

// Save workout set and continue to next set
function saveWorkoutSetAndContinue(sessionId, exerciseId, setNumber, totalSets) {
    const weightInput = document.querySelector(`input[name="weight_${setNumber}"]`);
    const repsInput = document.querySelector(`input[name="reps_${setNumber}"]`);
    
    if (!weightInput || !repsInput) {
        alert('Please fill in both weight and reps');
        return;
    }
    
    const weight = parseFloat(weightInput.value);
    const reps = parseInt(repsInput.value);
    
    if (isNaN(weight) || isNaN(reps) || weight <= 0 || reps <= 0) {
        alert('Please enter valid weight and reps');
        return;
    }
    
    // Create form data
    const formData = new FormData();
    formData.append('session_id', sessionId);
    formData.append('exercise_id', exerciseId);
    formData.append('set_number', setNumber);
    formData.append('weight', weight);
    formData.append('reps', reps);
    formData.append('csrfmiddlewaretoken', getCsrfToken());
    
    // Send to server
    fetch('/workouts/set/save/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add to completed sets
            addCompletedSet(setNumber, weight, reps, data.volume);
            
            // Check if this was the last set
            if (setNumber >= totalSets) {
                showExerciseComplete();
            } else {
                // Start rest timer if specified
                if (data.rest_time && data.rest_time > 0) {
                    startRestTimerWithCallback(data.rest_time, function() {
                        showNextSet(setNumber + 1);
                    });
                } else {
                    showNextSet(setNumber + 1);
                }
            }
        } else {
            alert('Error saving set: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving set');
    });
}

// Add completed set to the list
function addCompletedSet(setNumber, weight, reps, volume) {
    const completedSetsContainer = document.querySelector('.card-body .grid');
    
    if (!completedSetsContainer) {
        // Create the completed sets section if it doesn't exist
        const completedSetsCard = document.createElement('div');
        completedSetsCard.className = 'card mb-6';
        completedSetsCard.innerHTML = `
            <div class="card-header">Completed Sets</div>
            <div class="card-body">
                <div class="grid grid-cols-1 gap-3" id="completed-sets-grid">
                </div>
            </div>
        `;
        
        // Insert before the current set card
        const currentSetCard = document.getElementById('current-set-card');
        currentSetCard.parentNode.insertBefore(completedSetsCard, currentSetCard);
    }
    
    const grid = document.getElementById('completed-sets-grid') || document.querySelector('.card-body .grid');
    const now = new Date();
    const timeString = now.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
    
    const setDiv = document.createElement('div');
    setDiv.className = 'flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-200';
    setDiv.innerHTML = `
        <div>
            <span class="font-semibold">Set ${setNumber}</span>
            <span class="text-muted ml-2">${timeString}</span>
        </div>
        <div class="text-right">
            <div class="font-bold">${weight}kg √ó ${reps} reps</div>
            <div class="text-sm text-muted">Volume: ${volume}kg</div>
        </div>
    `;
    
    grid.appendChild(setDiv);
}

// Show next set form
function showNextSet(nextSetNumber) {
    currentSetNumber = nextSetNumber;
    
    // Update the header
    const header = document.querySelector('#current-set-card .card-header');
    header.textContent = `Set ${nextSetNumber}`;
    
    // Update form fields
    const weightInput = document.querySelector('input[name^="weight_"]');
    const repsInput = document.querySelector('input[name^="reps_"]');
    const saveButton = document.querySelector('button[id^="save-btn-"]');
    const volumeDisplay = document.querySelector('[id^="volume_"]');
    
    if (weightInput && repsInput && saveButton) {
        // Store the current values before updating
        const previousWeight = weightInput.value;
        const previousReps = repsInput.value;
        
        // Update input names and IDs
        weightInput.name = `weight_${nextSetNumber}`;
        weightInput.id = `weight_${nextSetNumber}`;
        // Carry forward the previous weight value
        weightInput.value = previousWeight || weightInput.defaultValue || '';
        
        repsInput.name = `reps_${nextSetNumber}`;
        repsInput.id = `reps_${nextSetNumber}`;
        // Carry forward the previous reps value
        repsInput.value = previousReps || repsInput.defaultValue || '';
        
        saveButton.id = `save-btn-${nextSetNumber}`;
        saveButton.onclick = function() {
            saveWorkoutSetAndContinue(sessionId, exerciseId, nextSetNumber, totalSets);
        };
        
        if (volumeDisplay) {
            volumeDisplay.id = `volume_${nextSetNumber}`;
            // Calculate volume with carried forward values
            updateVolume();
        }
        
        // Re-enable inputs and button
        weightInput.disabled = false;
        repsInput.disabled = false;
        saveButton.disabled = false;
        saveButton.textContent = 'Complete Set';
        saveButton.classList.remove('btn-secondary');
        saveButton.classList.add('btn-success');
        
        // Focus on weight input for easy adjustment
        weightInput.focus();
        weightInput.select(); // Select all text for easy replacement if needed
    }
}

// Show exercise complete message
function showExerciseComplete() {
    const currentSetCard = document.getElementById('current-set-card');
    currentSetCard.innerHTML = `
        <div class="card-header">Exercise Complete! üéâ</div>
        <div class="card-body text-center">
            <h3 class="text-2xl font-bold text-green-600 mb-4">All sets completed!</h3>
            <p class="text-muted mb-4">Great work! Ready to move on to the next exercise.</p>
            <a href="/workouts/session/${sessionId}/" class="btn btn-success btn-lg">
                Continue Workout
            </a>
        </div>
    `;
}

// Enhanced rest timer with callback
function startRestTimerWithCallback(seconds, callback) {
    if (restTimer) {
        clearInterval(restTimer);
    }
    
    restTimeRemaining = seconds;
    updateTimerDisplay();
    
    const timerElement = document.getElementById('rest-timer');
    if (timerElement) {
        timerElement.classList.remove('hidden');
        timerElement.style.display = 'flex';
        timerElement.setAttribute('data-active-timer', 'true');
    }
    
    restTimer = setInterval(() => {
        restTimeRemaining--;
        updateTimerDisplay();
        
        if (restTimeRemaining <= 0) {
            clearInterval(restTimer);
            onTimerCompleteWithCallback(callback);
        }
    }, 1000);
}

// Timer completion with callback
function onTimerCompleteWithCallback(callback) {
    const timerElement = document.getElementById('rest-timer');
    if (timerElement) {
        timerElement.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
                <div class="timer-display">
                    <div>Rest Complete! üéØ</div>
                    <div style="font-size: 1rem; margin-top: 0.5rem;">Ready for next set</div>
                </div>
                <div class="timer-controls">
                    <button class="btn btn-primary" onclick="continueToNextSet()">Start Next Set</button>
                </div>
            </div>
        `;
    }
    
    // Store callback for the continue button
    window.nextSetCallback = callback;
    
    // Play notification sound
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBT6azvO+ZykNJoPQ8diKOgsnfM7y2IlDA');
        audio.play();
    } catch (e) {
        // Silent fail if audio not supported
    }
}

// Continue to next set (called by timer completion button)
function continueToNextSet() {
    hideTimer();
    if (window.nextSetCallback) {
        window.nextSetCallback();
        window.nextSetCallback = null;
    }
}

// Skip rest timer and continue to next set
function skipRestAndContinue() {
    // Stop the timer
    if (restTimer) {
        clearInterval(restTimer);
        restTimer = null;
    }
    
    // Hide the timer
    hideTimer();
    
    // Execute the callback if it exists
    if (window.nextSetCallback) {
        window.nextSetCallback();
        window.nextSetCallback = null;
    }
}

// Utility function to get CSRF token
function getCsrfToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '';
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const weightInput = document.querySelector('input[name^="weight_"]');
    const repsInput = document.querySelector('input[name^="reps_"]');
    
    if (weightInput && repsInput) {
        weightInput.addEventListener('input', updateVolume);
        repsInput.addEventListener('input', updateVolume);
        
        // Calculate initial volume if values are present
        updateVolume();
        
        // Focus on weight input
        weightInput.focus();
    }
});
</script>
{% endblock %}